# Copyright (C) 2025 Iternal Technologies, Inc. All rights reserved.
#
# ===================================================================
# Deployment for Blockify Ingest (v1.0)
# 
# Contains the Kubernetes manifests for a complete deployment of the
# Blockify Ingest, powered by the NVIDIA NIM for Llama.
# ===================================================================

# ===================================================================
# 1. PersistentVolumeClaim (PVC)
# Requests persistent storage for the fine-tuned model weights.
# ===================================================================
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: blockify-model-pvc
spec:
  accessModes:
    # ReadWriteOnce is standard for a single-replica deployment.
    - ReadWriteOnce
  resources:
    requests:
      # 48Gi is a safe allocation for the 8B model.
      storage: 48Gi
  storageClassName: YOUR_STORAGE_CLASS # Replace with the cluster's available StorageClass

---
# ===================================================================
# 2. Deployment
# Defines the stateful workload for the Blockify NIM container.
# ===================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: blockify-model-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: blockify-model
  template:
    metadata:
      labels:
        app: blockify-model
    spec:
      containers:
      - name: blockify-nim-container
        # Standard NVIDIA NIM image for Llama 3 8B Base.
        image: nvcr.io/nim/meta/llama-3.1-8b-base:1.1.2

        # Configure the NIM container environment.
        env:
        # Tells the NIM to load the fine-tuned model
        # from the mounted storage path instead of the default.
        - name: NIM_MODEL_NAME
          value: "/models/blockify-8b"
        # Sets the public model name for the API (e.g., /v1/models).
        - name: NIM_SERVED_MODEL_NAME
          value: "blockify-8b"
        # Provides the NGC API key from a Kubernetes secret.
        - name: NGC_API_KEY
          valueFrom:
            secretKeyRef:
              name: YOUR_IMAGE_PULL_SECRET # Replace with the secret name for nvcr.io (e.g. nvcr-secret)
              key: NGC_API_KEY

        ports:
        # The NIM service runs on port 8000 by default.
        - containerPort: 8000
          name: http-api
        
        resources:
          limits:
            # Request one NVIDIA GPU.
            nvidia.com/gpu: 1

        volumeMounts:
        # Mount the persistent storage for model weights.
        - name: model-storage
          mountPath: /models
        # Mount the high-speed shared memory volume.
        - name: dshm
          mountPath: /dev/shm

      volumes:
      # Define the 'model-storage' volume linked to our PVC.
      - name: model-storage
        persistentVolumeClaim:
          claimName: blockify-model-pvc
      # Define 'dshm' as a 32Gi RAM-backed volume.
      - name: dshm
        emptyDir:
          medium: Memory
          sizeLimit: 32Gi

      # Define the secret needed to pull the image from nvcr.io.
      imagePullSecrets:
      - name: YOUR_IMAGE_PULL_SECRET # Replace with the secret name for nvcr.io (e.g. nvcr-secret)

---
# ===================================================================
# 3. Service
# Exposes the Deployment internally for testing and applications.
# ===================================================================
apiVersion: v1
kind: Service
metadata:
  name: blockify-model-service
spec:
  type: ClusterIP
  selector:
    app: blockify-model
  ports:
  - protocol: TCP
    # Expose the service on port 80.
    port: 80
    # Forward to port 8000 of container.
    targetPort: 8000
